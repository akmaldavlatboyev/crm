<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leads Management - Real Estate CRM</title>
    <link rel="stylesheet" href="styles.css">

</head>
<body>
    <div class="main-layout">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo">RealEstate CRM</a>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="index.html" class="nav-link">
                        <span class="nav-icon">üìä</span>
                        Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a href="leads.html" class="nav-link active">
                        <span class="nav-icon">üë•</span>
                        Leads
                    </a>
                </li>
                <li class="nav-item">
                    <a href="accounts.html" class="nav-link">
                        <span class="nav-icon">üè¢</span>
                        Accounts
                    </a>
                </li>
                <li class="nav-item">
                    <a href="contacts.html" class="nav-link">
                        <span class="nav-icon">üìû</span>
                        Contacts
                    </a>
                </li>
                <li class="nav-item">
                    <a href="deals.html" class="nav-link">
                        <span class="nav-icon">üíº</span>
                        Deals
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">Leads Management</h1>
                <p class="page-subtitle">Manage Your Property Leads - All Your Potential Clients in One Place</p>
            </div>

            <!-- Action Bar -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Lead Actions</h3>
                    <button class="btn btn-primary" onclick="openAddLeadModal()">
                        + Add New Lead
                    </button>
                </div>
                
                <!-- Search and Filter -->
                <div class="search-filters">
                    <div class="form-group">
                        <input type="text" id="search-leads" class="form-input" placeholder="Search leads by name, email, or phone...">
                    </div>
                    <div class="form-group">
                        <select id="filter-status" class="form-select">
                            <option value="">All Statuses</option>
                            <option value="new">New</option>
                            <option value="contacted">Contacted</option>
                            <option value="qualified">Qualified</option>
                            <option value="converted">Converted</option>
                            <option value="lost">Lost</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <select id="filter-source" class="form-select">
                            <option value="">All Sources</option>
                            <option value="website">Website</option>
                            <option value="referral">Referral</option>
                            <option value="social_media">Social Media</option>
                            <option value="advertisement">Advertisement</option>
                            <option value="cold_call">Cold Call</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Leads Table -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">All Leads</h3>
                    <span id="leads-count" class="text-secondary">Loading...</span>
                </div>
                
                <div class="table-container">
                    <table class="table" id="leads-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Status</th>
                                <th>Source</th>
                                <th>Interest</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="leads-tbody">
                            <tr>
                                <td colspan="8" class="text-center">
                                    <div class="loading"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Lead Modal -->
    <div id="lead-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Add New Lead</h3>
                <button class="modal-close" onclick="closeLeadModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="lead-form">
                    <input type="hidden" id="lead-id">
                    
                    <div class="form-group">
                        <label class="form-label" for="lead-name">Full Name *</label>
                        <input type="text" id="lead-name" class="form-input" required>
                        <div class="form-error" id="name-error"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="lead-email">Email Address *</label>
                        <input type="email" id="lead-email" class="form-input" required>
                        <div class="form-error" id="email-error"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="lead-phone">Phone Number</label>
                        <input type="tel" id="lead-phone" class="form-input">
                        <div class="form-error" id="phone-error"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="lead-status">Status</label>
                        <select id="lead-status" class="form-select">
                            <option value="new">New</option>
                            <option value="contacted">Contacted</option>
                            <option value="qualified">Qualified</option>
                            <option value="converted">Converted</option>
                            <option value="lost">Lost</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="lead-source">Lead Source</label>
                        <select id="lead-source" class="form-select">
                            <option value="website">Website</option>
                            <option value="referral">Referral</option>
                            <option value="social_media">Social Media</option>
                            <option value="advertisement">Advertisement</option>
                            <option value="cold_call">Cold Call</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="lead-interest">Property Interest</label>
                        <input type="text" id="lead-interest" class="form-input" placeholder="e.g., 3BR apartment downtown">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="lead-budget">Budget Range</label>
                        <input type="text" id="lead-budget" class="form-input" placeholder="e.g., $200,000 - $300,000">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="lead-notes">Notes</label>
                        <textarea id="lead-notes" class="form-textarea" rows="3" placeholder="Additional information about the lead..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeLeadModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveLead()" id="save-lead-btn">Save Lead</button>
            </div>
        </div>
    </div>

    <style>
        /* Leads page specific styles */
        .search-filters {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
        }

        .status-badge {
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-new { background-color: #dbeafe; color: #1e40af; }
        .status-contacted { background-color: #fef3c7; color: #92400e; }
        .status-qualified { background-color: #d1fae5; color: #065f46; }
        .status-converted { background-color: #dcfce7; color: #166534; }
        .status-lost { background-color: #fee2e2; color: #991b1b; }

        @media (max-width: 768px) {
            .search-filters {
                grid-template-columns: 1fr;
            }
            
            .table th:nth-child(6),
            .table td:nth-child(6),
            .table th:nth-child(7),
            .table td:nth-child(7) {
                display: none;
            }
        }
    </style>

    <script>
        // Leads management functionality
        let leads = [];
        let filteredLeads = [];
        let editingLeadId = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadLeads();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Search functionality
            DOM.get('search-leads').addEventListener('input', filterLeads);
            DOM.get('filter-status').addEventListener('change', filterLeads);
            DOM.get('filter-source').addEventListener('change', filterLeads);

            // Form validation
            DOM.get('lead-email').addEventListener('blur', validateEmail);
            DOM.get('lead-phone').addEventListener('blur', validatePhone);
        }

        async function loadLeads() {
            try {
                const response = await api.get('/leads');
                leads = response.data || [];
                filteredLeads = [...leads];
                renderLeadsTable();
                updateLeadsCount();
            } catch (error) {
                console.error('Error loading leads:', error);
                // Show sample data for demo
                leads = getSampleLeads();
                filteredLeads = [...leads];
                renderLeadsTable();
                updateLeadsCount();
                Notification.show('Using sample data - Connect to API for live data', 'warning');
            }
        }

        function getSampleLeads() {
            return [
                {
                    id: 1,
                    name: 'John Smith',
                    email: 'john.smith@email.com',
                    phone: '+1-555-0123',
                    status: 'qualified',
                    source: 'website',
                    interest: '3BR downtown apartment',
                    budget: '$250,000 - $300,000',
                    notes: 'Looking for move-in ready property',
                    created_at: '2024-01-15T10:30:00Z'
                },
                {
                    id: 2,
                    name: 'Sarah Johnson',
                    email: 'sarah.j@email.com',
                    phone: '+1-555-0124',
                    status: 'contacted',
                    source: 'referral',
                    interest: 'Family home with garden',
                    budget: '$400,000 - $500,000',
                    notes: 'Has two children, needs good school district',
                    created_at: '2024-01-14T14:20:00Z'
                },
                {
                    id: 3,
                    name: 'Mike Wilson',
                    email: 'mike.wilson@email.com',
                    phone: '+1-555-0125',
                    status: 'new',
                    source: 'social_media',
                    interest: 'Investment property',
                    budget: '$150,000 - $200,000',
                    notes: 'First-time investor',
                    created_at: '2024-01-13T09:15:00Z'
                }
            ];
        }

        function renderLeadsTable() {
            const tbody = DOM.get('leads-tbody');
            
            if (filteredLeads.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center">No leads found</td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredLeads.map(lead => `
                <tr>
                    <td><strong>${lead.name}</strong></td>
                    <td>${lead.email}</td>
                    <td>${lead.phone || '-'}</td>
                    <td><span class="status-badge status-${lead.status}">${lead.status}</span></td>
                    <td>${formatSource(lead.source)}</td>
                    <td>${lead.interest || '-'}</td>
                    <td>${formatDate(lead.created_at)}</td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-sm btn-secondary" onclick="editLead(${lead.id})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteLead(${lead.id})">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function filterLeads() {
            const searchTerm = DOM.get('search-leads').value.toLowerCase();
            const statusFilter = DOM.get('filter-status').value;
            const sourceFilter = DOM.get('filter-source').value;

            filteredLeads = leads.filter(lead => {
                const matchesSearch = !searchTerm || 
                    lead.name.toLowerCase().includes(searchTerm) ||
                    lead.email.toLowerCase().includes(searchTerm) ||
                    (lead.phone && lead.phone.includes(searchTerm));
                
                const matchesStatus = !statusFilter || lead.status === statusFilter;
                const matchesSource = !sourceFilter || lead.source === sourceFilter;

                return matchesSearch && matchesStatus && matchesSource;
            });

            renderLeadsTable();
            updateLeadsCount();
        }

        function updateLeadsCount() {
            const count = filteredLeads.length;
            const total = leads.length;
            DOM.get('leads-count').textContent = `Showing ${count} of ${total} leads`;
        }

        function openAddLeadModal() {
            editingLeadId = null;
            DOM.get('modal-title').textContent = 'Add New Lead';
            DOM.get('lead-form').reset();
            DOM.get('lead-id').value = '';
            clearFormErrors();
            Modal.show('lead-modal');
        }

        function editLead(id) {
            const lead = leads.find(l => l.id === id);
            if (!lead) return;

            editingLeadId = id;
            DOM.get('modal-title').textContent = 'Edit Lead';
            
            // Populate form
            DOM.get('lead-id').value = lead.id;
            DOM.get('lead-name').value = lead.name;
            DOM.get('lead-email').value = lead.email;
            DOM.get('lead-phone').value = lead.phone || '';
            DOM.get('lead-status').value = lead.status;
            DOM.get('lead-source').value = lead.source;
            DOM.get('lead-interest').value = lead.interest || '';
            DOM.get('lead-budget').value = lead.budget || '';
            DOM.get('lead-notes').value = lead.notes || '';

            clearFormErrors();
            Modal.show('lead-modal');
        }

        async function saveLead() {
            const formData = {
                name: DOM.get('lead-name').value.trim(),
                email: DOM.get('lead-email').value.trim(),
                phone: DOM.get('lead-phone').value.trim(),
                status: DOM.get('lead-status').value,
                source: DOM.get('lead-source').value,
                interest: DOM.get('lead-interest').value.trim(),
                budget: DOM.get('lead-budget').value.trim(),
                notes: DOM.get('lead-notes').value.trim()
            };

            // Validate form
            const validation = validateForm(formData, {
                name: ['required'],
                email: ['required', 'email'],
                phone: [{ validator: 'phone', message: 'Invalid phone number format' }]
            });

            if (!validation.isValid) {
                displayFormErrors(validation.errors);
                return;
            }

            const saveBtn = DOM.get('save-lead-btn');
            const originalText = saveBtn.textContent;
            
            try {
                Loading.show('save-lead-btn');

                if (editingLeadId) {
                    // Update existing lead
                    await api.put(`/leads/${editingLeadId}`, formData);
                    const index = leads.findIndex(l => l.id === editingLeadId);
                    if (index !== -1) {
                        leads[index] = { ...leads[index], ...formData };
                    }
                    Notification.show('Lead updated successfully', 'success');
                } else {
                    // Create new lead
                    const response = await api.post('/leads', formData);
                    const newLead = response.data || { 
                        ...formData, 
                        id: Date.now(), 
                        created_at: new Date().toISOString() 
                    };
                    leads.unshift(newLead);
                    Notification.show('Lead created successfully', 'success');
                }

                closeLeadModal();
                filterLeads(); // Refresh the display
            } catch (error) {
                console.error('Error saving lead:', error);
                Notification.show('Error saving lead', 'error');
            } finally {
                Loading.hide('save-lead-btn', originalText);
            }
        }

        async function deleteLead(id) {
            if (!confirm('Are you sure you want to delete this lead?')) {
                return;
            }

            try {
                await api.delete(`/leads/${id}`);
                leads = leads.filter(l => l.id !== id);
                filterLeads();
                Notification.show('Lead deleted successfully', 'success');
            } catch (error) {
                console.error('Error deleting lead:', error);
                Notification.show('Error deleting lead', 'error');
            }
        }

        function closeLeadModal() {
            Modal.hide('lead-modal');
            clearFormErrors();
        }

        function validateEmail() {
            const email = DOM.get('lead-email').value;
            const errorElement = DOM.get('email-error');
            
            if (email && !validators.email(email)) {
                errorElement.textContent = 'Please enter a valid email address';
                return false;
            } else {
                errorElement.textContent = '';
                return true;
            }
        }

        function validatePhone() {
            const phone = DOM.get('lead-phone').value;
            const errorElement = DOM.get('phone-error');
            
            if (phone && !validators.phone(phone)) {
                errorElement.textContent = 'Please enter a valid phone number';
                return false;
            } else {
                errorElement.textContent = '';
                return true;
            }
        }

        function displayFormErrors(errors) {
            clearFormErrors();
            
            for (const [field, message] of Object.entries(errors)) {
                const errorElement = DOM.get(`${field}-error`);
                if (errorElement) {
                    errorElement.textContent = message;
                }
            }
        }

        function clearFormErrors() {
            const errorElements = document.querySelectorAll('.form-error');
            errorElements.forEach(element => {
                element.textContent = '';
            });
        }

        function formatSource(source) {
            const sources = {
                website: 'Website',
                referral: 'Referral',
                social_media: 'Social Media',
                advertisement: 'Advertisement',
                cold_call: 'Cold Call'
            };
            return sources[source] || source;
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }
    </script>

        <script src="env.js"></script>
    <script src="utils.js"></script>
</body>
</html>
