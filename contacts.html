<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contacts - Real Estate CRM</title>
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo">RealEstate CRM</a>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="index.html" class="nav-link">
                        <span class="nav-icon">üìä</span>
                        Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a href="leads.html" class="nav-link">
                        <span class="nav-icon">üë•</span>
                        Leads
                    </a>
                </li>
                <li class="nav-item">
                    <a href="accounts.html" class="nav-link">
                        <span class="nav-icon">üè¢</span>
                        Accounts
                    </a>
                </li>
                <li class="nav-item">
                    <a href="contacts.html" class="nav-link active">
                        <span class="nav-icon">üìû</span>
                        Contacts
                    </a>
                </li>
                <li class="nav-item">
                    <a href="deals.html" class="nav-link">
                        <span class="nav-icon">üíº</span>
                        Deals
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page Header -->
            <header class="page-header">
                <div>
                    <h1 class="page-title">Contacts Management</h1>
                    <p class="page-subtitle">Manage your professional network and contacts</p>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="openAddContactModal()">Add New Contact</button>
                </div>
            </header>

            <!-- Search and Filters -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Search & Filter</h3>
                </div>
                <div style="display: flex; gap: var(--spacing-md); flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <input 
                            type="text" 
                            class="form-input" 
                            placeholder="Search contacts..." 
                            id="search-input"
                            oninput="handleSearch()"
                        >
                    </div>
                    <div style="min-width: 150px;">
                        <select class="form-select" id="department-filter" onchange="handleFilter()">
                            <option value="">All Departments</option>
                            <option value="sales">Sales</option>
                            <option value="marketing">Marketing</option>
                            <option value="finance">Finance</option>
                            <option value="operations">Operations</option>
                            <option value="management">Management</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div style="min-width: 150px;">
                        <select class="form-select" id="relationship-filter" onchange="handleFilter()">
                            <option value="">All Relationships</option>
                            <option value="client">Client</option>
                            <option value="prospect">Prospect</option>
                            <option value="partner">Partner</option>
                            <option value="vendor">Vendor</option>
                            <option value="colleague">Colleague</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Contacts Table -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Contacts List</h3>
                    <span id="contacts-count" style="color: var(--medium-gray);">Loading...</span>
                </div>
                
                <div class="table-container">
                    <table class="table" id="contacts-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Title & Company</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Relationship</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="contacts-tbody">
                            <tr>
                                <td colspan="7">
                                    <div class="loading">
                                        <div class="spinner"></div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Contact Modal -->
    <div id="contact-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Add New Contact</h2>
                <button class="close-btn" onclick="closeContactModal()">&times;</button>
            </div>
            
            <form id="contact-form" onsubmit="handleContactSubmit(event)">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                    <div class="form-group">
                        <label class="form-label" for="first-name">First Name *</label>
                        <input type="text" class="form-input" id="first-name" name="firstName" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="last-name">Last Name *</label>
                        <input type="text" class="form-input" id="last-name" name="lastName" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="email">Email *</label>
                    <input type="email" class="form-input" id="email" name="email" required>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                    <div class="form-group">
                        <label class="form-label" for="phone">Phone</label>
                        <input type="tel" class="form-input" id="phone" name="phone">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="mobile">Mobile</label>
                        <input type="tel" class="form-input" id="mobile" name="mobile">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="job-title">Job Title</label>
                    <input type="text" class="form-input" id="job-title" name="jobTitle" placeholder="e.g. Sales Manager">
                </div>

                <div class="form-group">
                    <label class="form-label" for="company">Company</label>
                    <input type="text" class="form-input" id="company" name="company">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                    <div class="form-group">
                        <label class="form-label" for="department">Department</label>
                        <select class="form-select" id="department" name="department">
                            <option value="">Select Department</option>
                            <option value="sales">Sales</option>
                            <option value="marketing">Marketing</option>
                            <option value="finance">Finance</option>
                            <option value="operations">Operations</option>
                            <option value="management">Management</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="relationship">Relationship *</label>
                        <select class="form-select" id="relationship" name="relationship" required>
                            <option value="prospect">Prospect</option>
                            <option value="client">Client</option>
                            <option value="partner">Partner</option>
                            <option value="vendor">Vendor</option>
                            <option value="colleague">Colleague</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="linkedin">LinkedIn Profile</label>
                    <input type="url" class="form-input" id="linkedin" name="linkedin" placeholder="https://linkedin.com/in/username">
                </div>

                <div class="form-group">
                    <label class="form-label" for="address">Address</label>
                    <textarea class="form-textarea" id="address" name="address" rows="2" placeholder="Business or home address..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label" for="birthday">Birthday</label>
                    <input type="date" class="form-input" id="birthday" name="birthday">
                </div>

                <div class="form-group">
                    <label class="form-label" for="contact-notes">Notes</label>
                    <textarea class="form-textarea" id="contact-notes" name="notes" rows="3" placeholder="Additional notes about this contact..."></textarea>
                </div>

                <div style="display: flex; gap: var(--spacing-md); justify-content: flex-end; margin-top: var(--spacing-xl);">
                    <button type="button" class="btn btn-secondary" onclick="closeContactModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submit-btn">Add Contact</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">Confirm Delete</h2>
                <button class="close-btn" onclick="closeDeleteModal()">&times;</button>
            </div>
            
            <p style="margin-bottom: var(--spacing-lg);">Are you sure you want to delete this contact? This action cannot be undone.</p>
            
            <div style="display: flex; gap: var(--spacing-md); justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="env.js"></script>
    <script src="js/utils.js"></script>
    <script>
        // Global variables
        let contacts = [];
        let filteredContacts = [];
        let editingContactId = null;
        let deletingContactId = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadContacts();
        });

        // Load contacts from API
        async function loadContacts() {
            try {
                showLoading(document.getElementById('contacts-tbody'));
                contacts = await apiClient.get('/contacts');
                filteredContacts = [...contacts];
                renderContactsTable();
                updateContactsCount();
            } catch (error) {
                console.error('Failed to load contacts:', error);
                document.getElementById('contacts-tbody').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: var(--danger-red); padding: var(--spacing-xl);">
                            Failed to load contacts. Please check your connection and try again.
                        </td>
                    </tr>
                `;
                showToast('Failed to load contacts', 'error');
            }
        }

        // Render contacts table
        function renderContactsTable() {
            const tbody = document.getElementById('contacts-tbody');
            
            if (filteredContacts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: var(--medium-gray); padding: var(--spacing-xl);">
                            No contacts found. Add your first contact to get started!
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredContacts.map(contact => `
                <tr>
                    <td>
                        <strong>${contact.firstName} ${contact.lastName}</strong>
                        ${contact.birthday ? `<br><small style="color: var(--medium-gray);">üéÇ ${formatBirthday(contact.birthday)}</small>` : ''}
                    </td>
                    <td>
                        ${contact.jobTitle ? `<strong>${contact.jobTitle}</strong><br>` : ''}
                        ${contact.company ? `<span style="color: var(--medium-gray);">${contact.company}</span>` : '-'}
                        ${contact.department ? `<br><small style="color: var(--accent-purple);">${capitalizeFirst(contact.department)}</small>` : ''}
                    </td>
                    <td>
                        <a href="mailto:${contact.email}" style="color: var(--accent-purple);">${contact.email}</a>
                    </td>
                    <td>
                        ${contact.phone ? `üìû ${contact.phone}` : ''}
                        ${contact.phone && contact.mobile ? '<br>' : ''}
                        ${contact.mobile ? `üì± ${contact.mobile}` : ''}
                        ${!contact.phone && !contact.mobile ? '-' : ''}
                    </td>
                    <td>
                        <span class="relationship-badge relationship-${contact.relationship}">${capitalizeFirst(contact.relationship)}</span>
                    </td>
                    <td>${formatDate(contact.createdAt || new Date())}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="editContact(${contact.id})" style="margin-right: var(--spacing-xs);">
                            Edit
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteContact(${contact.id})">
                            Delete
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Update contacts count
        function updateContactsCount() {
            document.getElementById('contacts-count').textContent = `${filteredContacts.length} contacts`;
        }

        // Handle search
        const handleSearch = debounce(function() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            applyFilters();
        }, 300);

        // Handle filters
        function handleFilter() {
            applyFilters();
        }

        // Apply search and filters
        function applyFilters() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const departmentFilter = document.getElementById('department-filter').value;
            const relationshipFilter = document.getElementById('relationship-filter').value;

            filteredContacts = contacts.filter(contact => {
                const matchesSearch = !searchTerm || 
                    contact.firstName.toLowerCase().includes(searchTerm) ||
                    contact.lastName.toLowerCase().includes(searchTerm) ||
                    contact.email.toLowerCase().includes(searchTerm) ||
                    (contact.company && contact.company.toLowerCase().includes(searchTerm)) ||
                    (contact.jobTitle && contact.jobTitle.toLowerCase().includes(searchTerm));

                const matchesDepartment = !departmentFilter || contact.department === departmentFilter;
                const matchesRelationship = !relationshipFilter || contact.relationship === relationshipFilter;

                return matchesSearch && matchesDepartment && matchesRelationship;
            });

            renderContactsTable();
            updateContactsCount();
        }

        // Open add contact modal
        function openAddContactModal() {
            editingContactId = null;
            document.getElementById('modal-title').textContent = 'Add New Contact';
            document.getElementById('submit-btn').textContent = 'Add Contact';
            document.getElementById('contact-form').reset();
            clearFormErrors();
            openModal('contact-modal');
        }

        // Close contact modal
        function closeContactModal() {
            closeModal('contact-modal');
            editingContactId = null;
        }

        // Edit contact
        function editContact(id) {
            const contact = contacts.find(c => c.id === id);
            if (!contact) return;

            editingContactId = id;
            document.getElementById('modal-title').textContent = 'Edit Contact';
            document.getElementById('submit-btn').textContent = 'Update Contact';

            // Populate form
            document.getElementById('first-name').value = contact.firstName || '';
            document.getElementById('last-name').value = contact.lastName || '';
            document.getElementById('email').value = contact.email || '';
            document.getElementById('phone').value = contact.phone || '';
            document.getElementById('mobile').value = contact.mobile || '';
            document.getElementById('job-title').value = contact.jobTitle || '';
            document.getElementById('company').value = contact.company || '';
            document.getElementById('department').value = contact.department || '';
            document.getElementById('relationship').value = contact.relationship || 'prospect';
            document.getElementById('linkedin').value = contact.linkedin || '';
            document.getElementById('address').value = contact.address || '';
            document.getElementById('birthday').value = contact.birthday || '';
            document.getElementById('contact-notes').value = contact.notes || '';

            clearFormErrors();
            openModal('contact-modal');
        }

        // Handle form submission
        async function handleContactSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const contactData = Object.fromEntries(formData.entries());

            // Validate form
            const validationRules = {
                firstName: [validators.required],
                lastName: [validators.required],
                email: [validators.required, validators.email],
                phone: [validators.phone],
                mobile: [validators.phone],
                relationship: [validators.required],
            };

            const errors = validateForm(contactData, validationRules);
            
            if (Object.keys(errors).length > 0) {
                displayFormErrors(errors);
                return;
            }

            try {
                clearFormErrors();
                const submitBtn = document.getElementById('submit-btn');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Saving...';
                submitBtn.disabled = true;

                if (editingContactId) {
                    // Update existing contact
                    await apiClient.put(`/contacts/${editingContactId}`, contactData);
                    showToast('Contact updated successfully!');
                } else {
                    // Create new contact
                    await apiClient.post('/contacts', contactData);
                    showToast('Contact added successfully!');
                }

                closeContactModal();
                await loadContacts();

            } catch (error) {
                console.error('Failed to save contact:', error);
                showToast('Failed to save contact. Please try again.', 'error');
            } finally {
                const submitBtn = document.getElementById('submit-btn');
                submitBtn.textContent = editingContactId ? 'Update Contact' : 'Add Contact';
                submitBtn.disabled = false;
            }
        }

        // Delete contact
        function deleteContact(id) {
            deletingContactId = id;
            openModal('delete-modal');
        }

        // Close delete modal
        function closeDeleteModal() {
            closeModal('delete-modal');
            deletingContactId = null;
        }

        // Confirm delete
        async function confirmDelete() {
            if (!deletingContactId) return;

            try {
                await apiClient.delete(`/contacts/${deletingContactId}`);
                showToast('Contact deleted successfully!');
                closeDeleteModal();
                await loadContacts();
            } catch (error) {
                console.error('Failed to delete contact:', error);
                showToast('Failed to delete contact. Please try again.', 'error');
            }
        }

        // Utility functions
        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function formatBirthday(birthday) {
            const date = new Date(birthday);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Add relationship badge styles
        const relationshipStyles = document.createElement('style');
        relationshipStyles.textContent = `
            .relationship-badge {
                padding: 0.25rem 0.5rem;
                border-radius: var(--radius-sm);
                font-size: 0.75rem;
                font-weight: 500;
                text-transform: uppercase;
            }
            .relationship-prospect { background-color: #dbeafe; color: #1e40af; }
            .relationship-client { background-color: #dcfce7; color: #166534; }
            .relationship-partner { background-color: #fef3c7; color: #92400e; }
            .relationship-vendor { background-color: #f3e8ff; color: #7c2d12; }
            .relationship-colleague { background-color: #e0e7ff; color: #3730a3; }
            
            @media (max-width: 768px) {
                .form-group {
                    grid-column: 1 / -1 !important;
                }
                #contact-form > div[style*="grid-template-columns"] {
                    grid-template-columns: 1fr !important;
                }
            }
        `;
        document.head.appendChild(relationshipStyles);
    </script>
</body>
</html>
