<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deals - Real Estate CRM</title>
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo">RealEstate CRM</a>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="index.html" class="nav-link">
                        <span class="nav-icon">üìä</span>
                        Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a href="leads.html" class="nav-link">
                        <span class="nav-icon">üë•</span>
                        Leads
                    </a>
                </li>
                <li class="nav-item">
                    <a href="accounts.html" class="nav-link">
                        <span class="nav-icon">üè¢</span>
                        Accounts
                    </a>
                </li>
                <li class="nav-item">
                    <a href="contacts.html" class="nav-link">
                        <span class="nav-icon">üìû</span>
                        Contacts
                    </a>
                </li>
                <li class="nav-item">
                    <a href="deals.html" class="nav-link active">
                        <span class="nav-icon">üíº</span>
                        Deals
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page Header -->
            <header class="page-header">
                <div>
                    <h1 class="page-title">Deals Management</h1>
                    <p class="page-subtitle">Track your sales pipeline and opportunities</p>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="openAddDealModal()">Add New Deal</button>
                </div>
            </header>

            <!-- Pipeline Summary -->
            <div class="pipeline-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md); margin-bottom: var(--spacing-xl);">
                <div class="card" style="text-align: center;">
                    <h4 style="color: var(--medium-gray); margin-bottom: var(--spacing-sm);">Total Pipeline</h4>
                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-purple);" id="total-pipeline">$0</div>
                </div>
                <div class="card" style="text-align: center;">
                    <h4 style="color: var(--medium-gray); margin-bottom: var(--spacing-sm);">Active Deals</h4>
                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--success-green);" id="active-deals">0</div>
                </div>
                <div class="card" style="text-align: center;">
                    <h4 style="color: var(--medium-gray); margin-bottom: var(--spacing-sm);">Won This Month</h4>
                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-color);" id="won-deals">$0</div>
                </div>
                <div class="card" style="text-align: center;">
                    <h4 style="color: var(--medium-gray); margin-bottom: var(--spacing-sm);">Avg Deal Size</h4>
                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning-yellow);" id="avg-deal">$0</div>
                </div>
            </div>

            <!-- Search and Filters -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Search & Filter</h3>
                </div>
                <div style="display: flex; gap: var(--spacing-md); flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <input 
                            type="text" 
                            class="form-input" 
                            placeholder="Search deals..." 
                            id="search-input"
                            oninput="handleSearch()"
                        >
                    </div>
                    <div style="min-width: 150px;">
                        <select class="form-select" id="stage-filter" onchange="handleFilter()">
                            <option value="">All Stages</option>
                            <option value="prospecting">Prospecting</option>
                            <option value="qualification">Qualification</option>
                            <option value="proposal">Proposal</option>
                            <option value="negotiation">Negotiation</option>
                            <option value="closed-won">Closed Won</option>
                            <option value="closed-lost">Closed Lost</option>
                        </select>
                    </div>
                    <div style="min-width: 150px;">
                        <select class="form-select" id="priority-filter" onchange="handleFilter()">
                            <option value="">All Priorities</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Deals Table -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Deals List</h3>
                    <span id="deals-count" style="color: var(--medium-gray);">Loading...</span>
                </div>
                
                <div class="table-container">
                    <table class="table" id="deals-table">
                        <thead>
                            <tr>
                                <th>Deal Name</th>
                                <th>Account</th>
                                <th>Value</th>
                                <th>Stage</th>
                                <th>Probability</th>
                                <th>Close Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="deals-tbody">
                            <tr>
                                <td colspan="7">
                                    <div class="loading">
                                        <div class="spinner"></div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Deal Modal -->
    <div id="deal-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Add New Deal</h2>
                <button class="close-btn" onclick="closeDealModal()">&times;</button>
            </div>
            
            <form id="deal-form" onsubmit="handleDealSubmit(event)">
                <div class="form-group">
                    <label class="form-label" for="deal-name">Deal Name *</label>
                    <input type="text" class="form-input" id="deal-name" name="dealName" required placeholder="e.g. ABC Corp - Office Space">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                    <div class="form-group">
                        <label class="form-label" for="account-name">Account/Company</label>
                        <input type="text" class="form-input" id="account-name" name="accountName" placeholder="Associated company">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="contact-name">Primary Contact</label>
                        <input type="text" class="form-input" id="contact-name" name="contactName" placeholder="Main contact person">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                    <div class="form-group">
                        <label class="form-label" for="deal-value">Deal Value *</label>
                        <input type="number" class="form-input" id="deal-value" name="dealValue" required min="0" step="0.01" placeholder="0.00">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="currency">Currency</label>
                        <select class="form-select" id="currency" name="currency">
                            <option value="USD">USD ($)</option>
                            <option value="EUR">EUR (‚Ç¨)</option>
                            <option value="GBP">GBP (¬£)</option>
                            <option value="UZS">UZS (so'm)</option>
                        </select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                    <div class="form-group">
                        <label class="form-label" for="stage">Stage *</label>
                        <select class="form-select" id="stage" name="stage" required onchange="updateProbability()">
                            <option value="prospecting">Prospecting</option>
                            <option value="qualification">Qualification</option>
                            <option value="proposal">Proposal</option>
                            <option value="negotiation">Negotiation</option>
                            <option value="closed-won">Closed Won</option>
                            <option value="closed-lost">Closed Lost</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="probability">Probability (%)</label>
                        <input type="number" class="form-input" id="probability" name="probability" min="0" max="100" placeholder="50">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                    <div class="form-group">
                        <label class="form-label" for="expected-close">Expected Close Date</label>
                        <input type="date" class="form-input" id="expected-close" name="expectedCloseDate">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="priority">Priority</label>
                        <select class="form-select" id="priority" name="priority">
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="property-type">Property Type</label>
                    <select class="form-select" id="property-type" name="propertyType">
                        <option value="">Select Type</option>
                        <option value="residential">Residential</option>
                        <option value="commercial">Commercial</option>
                        <option value="industrial">Industrial</option>
                        <option value="land">Land</option>
                        <option value="mixed-use">Mixed Use</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="deal-source">Deal Source</label>
                    <select class="form-select" id="deal-source" name="dealSource">
                        <option value="referral">Referral</option>
                        <option value="website">Website</option>
                        <option value="cold-call">Cold Call</option>
                        <option value="marketing">Marketing Campaign</option>
                        <option value="social-media">Social Media</option>
                        <option value="networking">Networking</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="deal-description">Description</label>
                    <textarea class="form-textarea" id="deal-description" name="description" rows="3" placeholder="Deal details, requirements, next steps..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label" for="deal-notes">Notes</label>
                    <textarea class="form-textarea" id="deal-notes" name="notes" rows="2" placeholder="Additional notes..."></textarea>
                </div>

                <div style="display: flex; gap: var(--spacing-md); justify-content: flex-end; margin-top: var(--spacing-xl);">
                    <button type="button" class="btn btn-secondary" onclick="closeDealModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submit-btn">Add Deal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">Confirm Delete</h2>
                <button class="close-btn" onclick="closeDeleteModal()">&times;</button>
            </div>
            
            <p style="margin-bottom: var(--spacing-lg);">Are you sure you want to delete this deal? This action cannot be undone.</p>
            
            <div style="display: flex; gap: var(--spacing-md); justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="env.js"></script>
    <script src="js/utils.js"></script>
    <script>
        // Global variables
        let deals = [];
        let filteredDeals = [];
        let editingDealId = null;
        let deletingDealId = null;

        // Stage probability mapping
        const stageProbabilities = {
            'prospecting': 10,
            'qualification': 25,
            'proposal': 50,
            'negotiation': 75,
            'closed-won': 100,
            'closed-lost': 0
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadDeals();
            setDefaultCloseDate();
        });

        // Set default close date (30 days from now)
        function setDefaultCloseDate() {
            const date = new Date();
            date.setDate(date.getDate() + 30);
            document.getElementById('expected-close').value = date.toISOString().split('T')[0];
        }

        // Update probability based on stage
        function updateProbability() {
            const stage = document.getElementById('stage').value;
            const probabilityInput = document.getElementById('probability');
            if (stage && stageProbabilities[stage] !== undefined) {
                probabilityInput.value = stageProbabilities[stage];
            }
        }

        // Load deals from API
        async function loadDeals() {
            try {
                showLoading(document.getElementById('deals-tbody'));
                deals = await apiClient.get('/deals');
                filteredDeals = [...deals];
                renderDealsTable();
                updateDealsCount();
                updatePipelineSummary();
            } catch (error) {
                console.error('Failed to load deals:', error);
                document.getElementById('deals-tbody').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: var(--danger-red); padding: var(--spacing-xl);">
                            Failed to load deals. Please check your connection and try again.
                        </td>
                    </tr>
                `;
                showToast('Failed to load deals', 'error');
            }
        }

        // Render deals table
        function renderDealsTable() {
            const tbody = document.getElementById('deals-tbody');
            
            if (filteredDeals.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: var(--medium-gray); padding: var(--spacing-xl);">
                            No deals found. Add your first deal to get started!
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredDeals.map(deal => `
                <tr>
                    <td>
                        <strong>${deal.dealName}</strong>
                        ${deal.propertyType ? `<br><small style="color: var(--medium-gray);">${capitalizeFirst(deal.propertyType)}</small>` : ''}
                        ${deal.priority === 'high' ? '<span style="color: var(--danger-red); margin-left: 8px;">üî•</span>' : ''}
                    </td>
                    <td>
                        ${deal.accountName ? `<strong>${deal.accountName}</strong>` : '-'}
                        ${deal.contactName ? `<br><small style="color: var(--medium-gray);">${deal.contactName}</small>` : ''}
                    </td>
                    <td>
                        <strong>${formatCurrency(deal.dealValue || 0)}</strong>
                        ${deal.currency && deal.currency !== 'USD' ? `<br><small>(${deal.currency})</small>` : ''}
                    </td>
                    <td>
                        <span class="stage-badge stage-${deal.stage}">${formatStage(deal.stage)}</span>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <div style="flex: 1; background: var(--light-gray); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="width: ${deal.probability || 0}%; height: 100%; background: var(--accent-purple); transition: width 0.3s ease;"></div>
                            </div>
                            <span style="font-size: 0.875rem; font-weight: 500;">${deal.probability || 0}%</span>
                        </div>
                    </td>
                    <td>
                        ${deal.expectedCloseDate ? formatDate(deal.expectedCloseDate) : '-'}
                        ${isOverdue(deal.expectedCloseDate, deal.stage) ? '<br><small style="color: var(--danger-red);">Overdue</small>' : ''}
                    </td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="editDeal(${deal.id})" style="margin-right: var(--spacing-xs);">
                            Edit
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteDeal(${deal.id})">
                            Delete
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Update deals count
        function updateDealsCount() {
            document.getElementById('deals-count').textContent = `${filteredDeals.length} deals`;
        }

        // Update pipeline summary
        function updatePipelineSummary() {
            const totalPipeline = deals.reduce((sum, deal) => {
                if (deal.stage !== 'closed-lost') {
                    return sum + (deal.dealValue || 0);
                }
                return sum;
            }, 0);

            const activeDeals = deals.filter(deal => 
                !['closed-won', 'closed-lost'].includes(deal.stage)
            ).length;

            const wonThisMonth = deals.filter(deal => {
                if (deal.stage !== 'closed-won') return false;
                const closeDate = new Date(deal.expectedCloseDate || deal.createdAt);
                const now = new Date();
                return closeDate.getMonth() === now.getMonth() && 
                       closeDate.getFullYear() === now.getFullYear();
            }).reduce((sum, deal) => sum + (deal.dealValue || 0), 0);

            const avgDeal = deals.length > 0 ? totalPipeline / deals.length : 0;

            document.getElementById('total-pipeline').textContent = formatCurrency(totalPipeline);
            document.getElementById('active-deals').textContent = activeDeals;
            document.getElementById('won-deals').textContent = formatCurrency(wonThisMonth);
            document.getElementById('avg-deal').textContent = formatCurrency(avgDeal);
        }

        // Handle search
        const handleSearch = debounce(function() {
            applyFilters();
        }, 300);

        // Handle filters
        function handleFilter() {
            applyFilters();
        }

        // Apply search and filters
        function applyFilters() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const stageFilter = document.getElementById('stage-filter').value;
            const priorityFilter = document.getElementById('priority-filter').value;

            filteredDeals = deals.filter(deal => {
                const matchesSearch = !searchTerm || 
                    deal.dealName.toLowerCase().includes(searchTerm) ||
                    (deal.accountName && deal.accountName.toLowerCase().includes(searchTerm)) ||
                    (deal.contactName && deal.contactName.toLowerCase().includes(searchTerm)) ||
                    (deal.description && deal.description.toLowerCase().includes(searchTerm));

                const matchesStage = !stageFilter || deal.stage === stageFilter;
                const matchesPriority = !priorityFilter || deal.priority === priorityFilter;

                return matchesSearch && matchesStage && matchesPriority;
            });

            renderDealsTable();
            updateDealsCount();
        }

        // Open add deal modal
        function openAddDealModal() {
            editingDealId = null;
            document.getElementById('modal-title').textContent = 'Add New Deal';
            document.getElementById('submit-btn').textContent = 'Add Deal';
            document.getElementById('deal-form').reset();
            setDefaultCloseDate();
            updateProbability();
            clearFormErrors();
            openModal('deal-modal');
        }

        // Close deal modal
        function closeDealModal() {
            closeModal('deal-modal');
            editingDealId = null;
        }

        // Edit deal
        function editDeal(id) {
            const deal = deals.find(d => d.id === id);
            if (!deal) return;

            editingDealId = id;
            document.getElementById('modal-title').textContent = 'Edit Deal';
            document.getElementById('submit-btn').textContent = 'Update Deal';

            // Populate form
            document.getElementById('deal-name').value = deal.dealName || '';
            document.getElementById('account-name').value = deal.accountName || '';
            document.getElementById('contact-name').value = deal.contactName || '';
            document.getElementById('deal-value').value = deal.dealValue || '';
            document.getElementById('currency').value = deal.currency || 'USD';
            document.getElementById('stage').value = deal.stage || 'prospecting';
            document.getElementById('probability').value = deal.probability || '';
            document.getElementById('expected-close').value = deal.expectedCloseDate || '';
            document.getElementById('priority').value = deal.priority || 'medium';
            document.getElementById('property-type').value = deal.propertyType || '';
            document.getElementById('deal-source').value = deal.dealSource || 'referral';
            document.getElementById('deal-description').value = deal.description || '';
            document.getElementById('deal-notes').value = deal.notes || '';

            clearFormErrors();
            openModal('deal-modal');
        }

        // Handle form submission
        async function handleDealSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const dealData = Object.fromEntries(formData.entries());

            // Convert dealValue to number
            dealData.dealValue = parseFloat(dealData.dealValue) || 0;
            dealData.probability = parseInt(dealData.probability) || 0;

            // Validate form
            const validationRules = {
                dealName: [validators.required],
                dealValue: [validators.required],
                stage: [validators.required],
            };

            const errors = validateForm(dealData, validationRules);
            
            if (Object.keys(errors).length > 0) {
                displayFormErrors(errors);
                return;
            }

            try {
                clearFormErrors();
                const submitBtn = document.getElementById('submit-btn');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Saving...';
                submitBtn.disabled = true;

                if (editingDealId) {
                    // Update existing deal
                    await apiClient.put(`/deals/${editingDealId}`, dealData);
                    showToast('Deal updated successfully!');
                } else {
                    // Create new deal
                    await apiClient.post('/deals', dealData);
                    showToast('Deal added successfully!');
                }

                closeDealModal();
                await loadDeals();

            } catch (error) {
                console.error('Failed to save deal:', error);
                showToast('Failed to save deal. Please try again.', 'error');
            } finally {
                const submitBtn = document.getElementById('submit-btn');
                submitBtn.textContent = editingDealId ? 'Update Deal' : 'Add Deal';
                submitBtn.disabled = false;
            }
        }

        // Delete deal
        function deleteDeal(id) {
            deletingDealId = id;
            openModal('delete-modal');
        }

        // Close delete modal
        function closeDeleteModal() {
            closeModal('delete-modal');
            deletingDealId = null;
        }

        // Confirm delete
        async function confirmDelete() {
            if (!deletingDealId) return;

            try {
                await apiClient.delete(`/deals/${deletingDealId}`);
                showToast('Deal deleted successfully!');
                closeDeleteModal();
                await loadDeals();
            } catch (error) {
                console.error('Failed to delete deal:', error);
                showToast('Failed to delete deal. Please try again.', 'error');
            }
        }

        // Utility functions
        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function formatStage(stage) {
            return stage.split('-').map(word => capitalizeFirst(word)).join(' ');
        }

        function isOverdue(dateString, stage) {
            if (!dateString || ['closed-won', 'closed-lost'].includes(stage)) return false;
            const closeDate = new Date(dateString);
            const now = new Date();
            return closeDate < now;
        }

        // Add stage badge styles
        const stageStyles = document.createElement('style');
        stageStyles.textContent = `
            .stage-badge {
                padding: 0.25rem 0.5rem;
                border-radius: var(--radius-sm);
                font-size: 0.75rem;
                font-weight: 500;
                text-transform: uppercase;
            }
            .stage-prospecting { background-color: #f3f4f6; color: #374151; }
            .stage-qualification { background-color: #dbeafe; color: #1e40af; }
            .stage-proposal { background-color: #fef3c7; color: #92400e; }
            .stage-negotiation { background-color: #fde68a; color: #78350f; }
            .stage-closed-won { background-color: #dcfce7; color: #166534; }
            .stage-closed-lost { background-color: #fee2e2; color: #991b1b; }
            
            @media (max-width: 768px) {
                .pipeline-summary {
                    grid-template-columns: repeat(2, 1fr) !important;
                }
                .form-group {
                    grid-column: 1 / -1 !important;
                }
                #deal-form > div[style*="grid-template-columns"] {
                    grid-template-columns: 1fr !important;
                }
            }
        `;
        document.head.appendChild(stageStyles);
    </script>
</body>
</html>
