<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accounts - Real Estate CRM</title>
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo">RealEstate CRM</a>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="index.html" class="nav-link">
                        <span class="nav-icon">üìä</span>
                        Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a href="leads.html" class="nav-link">
                        <span class="nav-icon">üë•</span>
                        Leads
                    </a>
                </li>
                <li class="nav-item">
                    <a href="accounts.html" class="nav-link active">
                        <span class="nav-icon">üè¢</span>
                        Accounts
                    </a>
                </li>
                <li class="nav-item">
                    <a href="contacts.html" class="nav-link">
                        <span class="nav-icon">üìû</span>
                        Contacts
                    </a>
                </li>
                <li class="nav-item">
                    <a href="deals.html" class="nav-link">
                        <span class="nav-icon">üíº</span>
                        Deals
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page Header -->
            <header class="page-header">
                <div>
                    <h1 class="page-title">Accounts Management</h1>
                    <p class="page-subtitle">Manage your business accounts and companies</p>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="openAddAccountModal()">Add New Account</button>
                </div>
            </header>

            <!-- Search and Filters -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Search & Filter</h3>
                </div>
                <div style="display: flex; gap: var(--spacing-md); flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <input 
                            type="text" 
                            class="form-input" 
                            placeholder="Search accounts..." 
                            id="search-input"
                            oninput="handleSearch()"
                        >
                    </div>
                    <div style="min-width: 150px;">
                        <select class="form-select" id="industry-filter" onchange="handleFilter()">
                            <option value="">All Industries</option>
                            <option value="real-estate">Real Estate</option>
                            <option value="construction">Construction</option>
                            <option value="finance">Finance</option>
                            <option value="technology">Technology</option>
                            <option value="retail">Retail</option>
                            <option value="healthcare">Healthcare</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div style="min-width: 150px;">
                        <select class="form-select" id="type-filter" onchange="handleFilter()">
                            <option value="">All Types</option>
                            <option value="client">Client</option>
                            <option value="prospect">Prospect</option>
                            <option value="partner">Partner</option>
                            <option value="vendor">Vendor</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Accounts Table -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Accounts List</h3>
                    <span id="accounts-count" style="color: var(--medium-gray);">Loading...</span>
                </div>
                
                <div class="table-container">
                    <table class="table" id="accounts-table">
                        <thead>
                            <tr>
                                <th>Company Name</th>
                                <th>Industry</th>
                                <th>Type</th>
                                <th>Website</th>
                                <th>Phone</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="accounts-tbody">
                            <tr>
                                <td colspan="7">
                                    <div class="loading">
                                        <div class="spinner"></div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Account Modal -->
    <div id="account-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Add New Account</h2>
                <button class="close-btn" onclick="closeAccountModal()">&times;</button>
            </div>
            
            <form id="account-form" onsubmit="handleAccountSubmit(event)">
                <div class="form-group">
                    <label class="form-label" for="company-name">Company Name *</label>
                    <input type="text" class="form-input" id="company-name" name="companyName" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="industry">Industry *</label>
                    <select class="form-select" id="industry" name="industry" required>
                        <option value="">Select Industry</option>
                        <option value="real-estate">Real Estate</option>
                        <option value="construction">Construction</option>
                        <option value="finance">Finance</option>
                        <option value="technology">Technology</option>
                        <option value="retail">Retail</option>
                        <option value="healthcare">Healthcare</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="account-type">Account Type *</label>
                    <select class="form-select" id="account-type" name="accountType" required>
                        <option value="prospect">Prospect</option>
                        <option value="client">Client</option>
                        <option value="partner">Partner</option>
                        <option value="vendor">Vendor</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="website">Website</label>
                    <input type="url" class="form-input" id="website" name="website" placeholder="https://example.com">
                </div>

                <div class="form-group">
                    <label class="form-label" for="account-phone">Phone</label>
                    <input type="tel" class="form-input" id="account-phone" name="phone">
                </div>

                <div class="form-group">
                    <label class="form-label" for="account-email">Email</label>
                    <input type="email" class="form-input" id="account-email" name="email">
                </div>

                <div class="form-group">
                    <label class="form-label" for="address">Address</label>
                    <textarea class="form-textarea" id="address" name="address" rows="2" placeholder="Company address..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label" for="employees">Number of Employees</label>
                    <select class="form-select" id="employees" name="employees">
                        <option value="">Select Size</option>
                        <option value="1-10">1-10</option>
                        <option value="11-50">11-50</option>
                        <option value="51-200">51-200</option>
                        <option value="201-500">201-500</option>
                        <option value="500+">500+</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="annual-revenue">Annual Revenue</label>
                    <select class="form-select" id="annual-revenue" name="annualRevenue">
                        <option value="">Select Range</option>
                        <option value="under-1m">Under $1M</option>
                        <option value="1m-10m">$1M - $10M</option>
                        <option value="10m-50m">$10M - $50M</option>
                        <option value="50m-100m">$50M - $100M</option>
                        <option value="over-100m">Over $100M</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="account-notes">Notes</label>
                    <textarea class="form-textarea" id="account-notes" name="notes" rows="3" placeholder="Additional notes about this account..."></textarea>
                </div>

                <div style="display: flex; gap: var(--spacing-md); justify-content: flex-end; margin-top: var(--spacing-xl);">
                    <button type="button" class="btn btn-secondary" onclick="closeAccountModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submit-btn">Add Account</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">Confirm Delete</h2>
                <button class="close-btn" onclick="closeDeleteModal()">&times;</button>
            </div>
            
            <p style="margin-bottom: var(--spacing-lg);">Are you sure you want to delete this account? This action cannot be undone.</p>
            
            <div style="display: flex; gap: var(--spacing-md); justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="env.js"></script>
    <script src="js/utils.js"></script>
    <script>
        // Global variables
        let accounts = [];
        let filteredAccounts = [];
        let editingAccountId = null;
        let deletingAccountId = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadAccounts();
        });

        // Load accounts from API
        async function loadAccounts() {
            try {
                showLoading(document.getElementById('accounts-tbody'));
                accounts = await apiClient.get('/accounts');
                filteredAccounts = [...accounts];
                renderAccountsTable();
                updateAccountsCount();
            } catch (error) {
                console.error('Failed to load accounts:', error);
                document.getElementById('accounts-tbody').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: var(--danger-red); padding: var(--spacing-xl);">
                            Failed to load accounts. Please check your connection and try again.
                        </td>
                    </tr>
                `;
                showToast('Failed to load accounts', 'error');
            }
        }

        // Render accounts table
        function renderAccountsTable() {
            const tbody = document.getElementById('accounts-tbody');
            
            if (filteredAccounts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: var(--medium-gray); padding: var(--spacing-xl);">
                            No accounts found. Add your first account to get started!
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredAccounts.map(account => `
                <tr>
                    <td>
                        <strong>${account.companyName}</strong>
                        ${account.address ? `<br><small style="color: var(--medium-gray);">${account.address}</small>` : ''}
                    </td>
                    <td>${formatIndustry(account.industry)}</td>
                    <td>
                        <span class="type-badge type-${account.accountType}">${capitalizeFirst(account.accountType)}</span>
                    </td>
                    <td>
                        ${account.website ? `<a href="${account.website}" target="_blank" style="color: var(--accent-purple);">${getDomain(account.website)}</a>` : '-'}
                    </td>
                    <td>${account.phone || '-'}</td>
                    <td>${formatDate(account.createdAt || new Date())}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="editAccount(${account.id})" style="margin-right: var(--spacing-xs);">
                            Edit
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteAccount(${account.id})">
                            Delete
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Update accounts count
        function updateAccountsCount() {
            document.getElementById('accounts-count').textContent = `${filteredAccounts.length} accounts`;
        }

        // Handle search
        const handleSearch = debounce(function() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            applyFilters();
        }, 300);

        // Handle filters
        function handleFilter() {
            applyFilters();
        }

        // Apply search and filters
        function applyFilters() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const industryFilter = document.getElementById('industry-filter').value;
            const typeFilter = document.getElementById('type-filter').value;

            filteredAccounts = accounts.filter(account => {
                const matchesSearch = !searchTerm || 
                    account.companyName.toLowerCase().includes(searchTerm) ||
                    (account.industry && account.industry.toLowerCase().includes(searchTerm)) ||
                    (account.address && account.address.toLowerCase().includes(searchTerm));

                const matchesIndustry = !industryFilter || account.industry === industryFilter;
                const matchesType = !typeFilter || account.accountType === typeFilter;

                return matchesSearch && matchesIndustry && matchesType;
            });

            renderAccountsTable();
            updateAccountsCount();
        }

        // Open add account modal
        function openAddAccountModal() {
            editingAccountId = null;
            document.getElementById('modal-title').textContent = 'Add New Account';
            document.getElementById('submit-btn').textContent = 'Add Account';
            document.getElementById('account-form').reset();
            clearFormErrors();
            openModal('account-modal');
        }

        // Close account modal
        function closeAccountModal() {
            closeModal('account-modal');
            editingAccountId = null;
        }

        // Edit account
        function editAccount(id) {
            const account = accounts.find(a => a.id === id);
            if (!account) return;

            editingAccountId = id;
            document.getElementById('modal-title').textContent = 'Edit Account';
            document.getElementById('submit-btn').textContent = 'Update Account';

            // Populate form
            document.getElementById('company-name').value = account.companyName || '';
            document.getElementById('industry').value = account.industry || '';
            document.getElementById('account-type').value = account.accountType || 'prospect';
            document.getElementById('website').value = account.website || '';
            document.getElementById('account-phone').value = account.phone || '';
            document.getElementById('account-email').value = account.email || '';
            document.getElementById('address').value = account.address || '';
            document.getElementById('employees').value = account.employees || '';
            document.getElementById('annual-revenue').value = account.annualRevenue || '';
            document.getElementById('account-notes').value = account.notes || '';

            clearFormErrors();
            openModal('account-modal');
        }

        // Handle form submission
        async function handleAccountSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const accountData = Object.fromEntries(formData.entries());

            // Validate form
            const validationRules = {
                companyName: [validators.required],
                industry: [validators.required],
                accountType: [validators.required],
                email: [validators.email],
                phone: [validators.phone],
            };

            const errors = validateForm(accountData, validationRules);
            
            if (Object.keys(errors).length > 0) {
                displayFormErrors(errors);
                return;
            }

            try {
                clearFormErrors();
                const submitBtn = document.getElementById('submit-btn');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Saving...';
                submitBtn.disabled = true;

                if (editingAccountId) {
                    // Update existing account
                    await apiClient.put(`/accounts/${editingAccountId}`, accountData);
                    showToast('Account updated successfully!');
                } else {
                    // Create new account
                    await apiClient.post('/accounts', accountData);
                    showToast('Account added successfully!');
                }

                closeAccountModal();
                await loadAccounts();

            } catch (error) {
                console.error('Failed to save account:', error);
                showToast('Failed to save account. Please try again.', 'error');
            } finally {
                const submitBtn = document.getElementById('submit-btn');
                submitBtn.textContent = editingAccountId ? 'Update Account' : 'Add Account';
                submitBtn.disabled = false;
            }
        }

        // Delete account
        function deleteAccount(id) {
            deletingAccountId = id;
            openModal('delete-modal');
        }

        // Close delete modal
        function closeDeleteModal() {
            closeModal('delete-modal');
            deletingAccountId = null;
        }

        // Confirm delete
        async function confirmDelete() {
            if (!deletingAccountId) return;

            try {
                await apiClient.delete(`/accounts/${deletingAccountId}`);
                showToast('Account deleted successfully!');
                closeDeleteModal();
                await loadAccounts();
            } catch (error) {
                console.error('Failed to delete account:', error);
                showToast('Failed to delete account. Please try again.', 'error');
            }
        }

        // Utility functions
        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function formatIndustry(industry) {
            return industry ? industry.split('-').map(word => capitalizeFirst(word)).join(' ') : 'Unknown';
        }

        function getDomain(url) {
            try {
                return new URL(url).hostname.replace('www.', '');
            } catch {
                return url;
            }
        }

        // Add type badge styles
        const typeStyles = document.createElement('style');
        typeStyles.textContent = `
            .type-badge {
                padding: 0.25rem 0.5rem;
                border-radius: var(--radius-sm);
                font-size: 0.75rem;
                font-weight: 500;
                text-transform: uppercase;
            }
            .type-prospect { background-color: #dbeafe; color: #1e40af; }
            .type-client { background-color: #dcfce7; color: #166534; }
            .type-partner { background-color: #fef3c7; color: #92400e; }
            .type-vendor { background-color: #f3e8ff; color: #7c2d12; }
        `;
        document.head.appendChild(typeStyles);
    </script>
</body>
</html>
